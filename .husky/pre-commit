#!/bin/sh

# ============================================================================
# Pre-commit hook: Enforce test coverage for both frontend and backend
# ============================================================================

# Check cargo-llvm-cov is installed (required for Rust coverage)
if ! command -v cargo-llvm-cov >/dev/null 2>&1; then
  echo ""
  echo "ERROR: cargo-llvm-cov not installed"
  echo "Install with: cargo install cargo-llvm-cov"
  echo ""
  exit 1
fi

# ============================================================================
# Frontend Tests (Bun)
# ============================================================================

echo "Running frontend tests with coverage..."
bun test --coverage

if [ $? -ne 0 ]; then
  echo ""
  echo "Pre-commit failed: frontend tests failed or coverage < 100%"
  echo "Fix failing tests and ensure 100% coverage before committing."
  exit 1
fi

echo "Frontend tests passed!"

# ============================================================================
# Backend Tests (Rust)
# ============================================================================

echo ""
echo "Running backend tests with coverage..."
cd src-tauri
# Uses +nightly toolchain for #[coverage(off)] attribute support
# 100% coverage required - untestable code must be excluded via #[coverage(off)]
cargo +nightly llvm-cov --fail-under-lines 100 --fail-under-functions 100

if [ $? -ne 0 ]; then
  echo ""
  echo "Pre-commit failed: backend tests failed or coverage < 100%"
  echo "Fix failing tests and ensure 100% coverage before committing."
  echo "Use #[coverage(off)] to exclude untestable code."
  cd ..
  exit 1
fi

cd ..
echo "Backend tests passed!"

# ============================================================================
# All tests passed
# ============================================================================

echo ""
echo "All tests passed with required coverage!"
