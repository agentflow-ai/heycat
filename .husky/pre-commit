#!/bin/sh

# ============================================================================
# Pre-commit hook: Enforce test coverage for both frontend and backend
# ============================================================================

# Check cargo-llvm-cov is installed (required for Rust coverage)
if ! command -v cargo-llvm-cov >/dev/null 2>&1; then
  echo ""
  echo "ERROR: cargo-llvm-cov not installed"
  echo "Install with: cargo install cargo-llvm-cov"
  echo ""
  exit 1
fi

# ============================================================================
# Frontend Tests (Bun)
# ============================================================================

echo "Running frontend tests with coverage..."
bun test --coverage

if [ $? -ne 0 ]; then
  echo ""
  echo "Pre-commit failed: frontend tests failed or coverage < 80%"
  echo "Fix failing tests and ensure adequate coverage before committing."
  exit 1
fi

echo "Frontend tests passed!"

# ============================================================================
# Backend Tests (Rust)
# ============================================================================

echo ""
echo "Running backend tests with coverage..."
cd src-tauri
# Exclude main.rs (binary entry point)
# Note: Line threshold is 65% to account for untestable GUI code (run function)
# Function threshold remains at 80%
cargo llvm-cov --ignore-filename-regex "main\.rs" --fail-under-lines 65 --fail-under-functions 80

if [ $? -ne 0 ]; then
  echo ""
  echo "Pre-commit failed: backend tests failed or coverage insufficient"
  echo "Required: 65% line coverage, 80% function coverage"
  echo "Fix failing tests and ensure adequate coverage before committing."
  cd ..
  exit 1
fi

cd ..
echo "Backend tests passed!"

# ============================================================================
# All tests passed
# ============================================================================

echo ""
echo "All tests passed with required coverage!"
