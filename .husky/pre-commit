#!/bin/sh

# ============================================================================
# Pre-commit hook: Enforce test coverage for both frontend and backend
# ============================================================================

# Check cargo-llvm-cov is installed (required for Rust coverage)
if ! command -v cargo-llvm-cov >/dev/null 2>&1; then
  echo ""
  echo "ERROR: cargo-llvm-cov not installed"
  echo "Install with: cargo install cargo-llvm-cov"
  echo ""
  exit 1
fi

# ============================================================================
# Frontend Tests (Vitest)
# ============================================================================

echo "Running frontend tests with coverage..."
bun run test:coverage

if [ $? -ne 0 ]; then
  echo ""
  echo "Pre-commit failed: frontend tests failed or coverage < 60%"
  echo "Fix failing tests and ensure 60% coverage before committing."
  echo "Use /* v8 ignore ... -- @preserve */ to exclude untestable code."
  exit 1
fi

echo "Frontend tests passed!"

# ============================================================================
# Backend Tests (Rust)
# ============================================================================

echo ""
echo "Running backend tests with coverage..."
cd src-tauri
# Uses +nightly toolchain for #[coverage(off)] attribute support
# 60% coverage required for smoke testing - untestable code can be excluded via #[coverage(off)]
# Exclude *_test.rs files from coverage measurement (they are test code, not production code)
cargo +nightly llvm-cov --fail-under-lines 60 --fail-under-functions 60 --ignore-filename-regex '_test\.rs$'

if [ $? -ne 0 ]; then
  echo ""
  echo "Pre-commit failed: backend tests failed or coverage < 60%"
  echo "Fix failing tests and ensure 60% coverage before committing."
  echo "Use #[coverage(off)] to exclude untestable code."
  cd ..
  exit 1
fi

cd ..
echo "Backend tests passed!"

# ============================================================================
# All tests passed
# ============================================================================

echo ""
echo "All tests passed with required coverage!"
